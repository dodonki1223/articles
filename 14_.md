# データベースの結合アルゴリズムについてのまとめ

よく忘れてしまうので自分でまとめることによってちゃんと覚えるようにする

## 概要

データベース内部ではテーブル同士の結合がされる時、主に以下の３つのうちどれかの結合アルゴリズムが使用される

- Nested Loops Join
- Hash Join
- Sort Merge Join

**注意**

使用する結合アルゴリズムを明示的に指定することもできるが、データ量や構造が変わった時に使用されるべき結合アルゴリズムは変わってくるため基本的にオプティマイザに任せた方が無難だと思われる

## Nested Loops Join

言葉の通り、ネストされたループ（２重ループ）を行うアルゴリズムになります  
**外部表の１行ごと**に**内部表を１行ずつ**見に行き、合致したものを返却する動作になります

![nested_loop_join_01](https://raw.githubusercontent.com/dodonki1223/image_garage/master/qiita/14/nested_loop_join/01.png)

### 特徴

- 外部表と内部表の行数に応じて実行時間が変わってくる
- **Hash Join** や **Sort Merge Join** に比べてメモリをあまり使わない（１つ１つの処理がそこまで重くないため）

### アクセスされる行数について

基本的には二重ループなので **外部表の行数 x 内部表の行数** になります  

ただし内部表の結合キーにインデックスがある場合は内部表の走査が短縮されます。インデックスにより行が１行に特定できる場合は **外部表の行数 x 2** になります

![nested_loop_join_02](https://raw.githubusercontent.com/dodonki1223/image_garage/master/qiita/14/nested_loop_join/02.png)

アクセスされる行数が実行時間に比例するので動作を速くしたい場合はインデックスを使用するべきでしょう

### パフォーマンス・チューニング

Nested Loops Join を使用している場合でパフォーマンスを上げるには下記を意識すると良い

- 外部表を小さく（そもそものループが小さくなるように）
- 内部表を大きく（ただし結合キーにはインデックスが貼られていること）

ただし、検索条件なんかにより **内部表の行数が多くなる場合** はあえて、外部表と内部表を入れ替えることも選択肢に入れると良い

### その他

- MySQLの結合アルゴリズムはこの **Nested Loops Join** しかありません
- 動画でわかりやすく動作の説明をされています
    - [The Importance of Nested Loops Joins in SQL](https://www.youtube.com/watch?v=0arjvMJihJo)

## Hash Join

結合対象のテーブルのうち **小さいテーブル（メモリ上に作成されるため小さいテーブルの方が効率がよい）をスキャン** し結合キーに対してのハッシュ値を生成した **ハッシュテーブルをメモリ上** に作成します

![hash_join_01](https://raw.githubusercontent.com/dodonki1223/image_garage/master/qiita/14/hash_join/01.png)

**大きいテーブル** に対して、 **ハッシュテーブルの結合キーのハッシュ値が存在するか調べマッチしたもの** で結合を行う

![hash_join_02](https://raw.githubusercontent.com/dodonki1223/image_garage/master/qiita/14/hash_join/02.png)

### 特徴

- メモリ上にハッシュテーブルを作成するため、Nested Loops Join に比べてメモリを多く使用する
- ハッシュテーブルの容量がメモリの上限を越えるとストレージを使用するため、速度が遅くなる
- ハッシュ値に順番の概念がないため等値結合（`=` での結合）でしか使用できない

### Nested Loops Join ではなく Hash Join を使用するケース

Nested Loops Join が **効率的に動作しない時は Hash Join を使用する** とよい

- Nested Loops Join で適切な外部表が存在しない時（外部表が小さいテーブルでない時）
- Nested Loops Join で使用する内部表で走査される行数が多い時
- Nested Loops Join で使用する内部表にインデックスが存在しないもしくはインデックスを追加することができない時

### その他

- 夜間バッチ（同時並走する処理の少ない）、[BI／DWH](https://it-trend.jp/bi/article/bi_dwh) のようなスループットの低いシステムで使用すると良い
    - ハッシュテーブルの作成でメモリを多く使用するため
- 実行時間の考慮が必要（性質上、両方のテーブルでフルスキャンが実行されるため）
- 動画でわかりやすく動作の説明をされています
    - [Hash Match Join Internals in SQL Server](https://www.youtube.com/watch?v=59C8c7p_hII)
